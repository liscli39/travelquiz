<!-- chat/templates/chat/room.html -->
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-MrcW6ZMFYlzcLA8Nl+NtUVF0sA7MsXsP1UyJoMp4YLEuNSfAP+JcXn/tWtIaxVXM" crossorigin="anonymous"></script>
    <title>Chat Room</title>
</head>
<body style="height: 100vh;">
  <div class="d-flex h-100">
    <div class="col-6 m-2 border-end">
      <h4>Team</h4>
      <div id="login_form">
        <input id="login_id" placeholder="Login ID" type="text">
        <input id="login_id_submit" type="button" value="Submit">
      </div>
  
      <div id="content" class="d-none">
        <textarea placeholder="data" id="data" cols="100" rows="20"></textarea><br>
        <input placeholder="method"  id="method" type="text" size="100" value="login"><br>
        <input id="chat-message-submit" type="button" value="Send">
      </div>
    </div>
    <div class="col-6 m-2">
      <h4>Admin</h4>
      <button id="get_question">Lấy danh sách câu hỏi</button>
    </div>
  </div>


    <script>
        class Client {
          constructor(type) {
            this.id = null;
            this.token = null;
            this.event_count = 0;
            this.events = {};
            this.callbacks = {};

            const url = 'ws://' + window.location.host + '/ws/' + type +'/';
            this.chatSocket = new WebSocket(url);

            const client = this;
            this.chatSocket.onmessage = function(e) {
                const { type, data, seq } = JSON.parse(e.data);

                if (type == "send_response") {
                  const callback = client.callbacks[seq];
                  if (typeof callback === "function") callback(data);
                  delete client.callbacks[seq];
                } else {
                  const func = client.events[type];
                  if (typeof func === "function") func(e, data);
                }
            };
    
            this.chatSocket.onclose = function(e) {
              console.error('Chat socket closed unexpectedly');
            };
          }
          
          send(method, args, callback) {
            const client = this;
            this.callbacks[this.event_count] = callback;
            this.chatSocket.send(JSON.stringify({
              'seq': this.event_count ++,
              'id': client.id,
              'pin': this.token,
              'type': method,
              'args': args,
            }));
          }
        }

        const client_team = new Client('team');
        const client_admin = new Client('admin');

        document.querySelector('#login_id_submit').onclick = function(e) {
          const value = document.querySelector('#login_id').value;

          client_team.send("login", { username: value }, (ret) => {
            const { role } = ret;
            document.querySelector('#login_form').style.display = "none";
            document.querySelector('#content').style.display = "block";
          })
        };

        document.querySelector('#get_question').onclick = function(e) {
          client_admin.send("get_questions", {}, (questions) => {
            console.log('questions', questions)
            for (const question of questions) {
                console.log(question)
            }
          })
        }
    </script>
</body>
</html>