{% extends "admin/base_site.html" %}
{% load i18n static %}

{% block extrastyle %}{{ block.super }}<link rel="stylesheet" href="{% static "admin/css/dashboard.css" %}">{% endblock %}

{% block coltype %}colMS{% endblock %}

{% block bodyclass %}{{ block.super }} dashboard{% endblock %}

{% block nav-breadcrumbs %}{% endblock %}

{% block nav-sidebar %}{% endblock %}

{% block content %}
<div id="content-main">
  {% include "admin/app_list.html" with app_list=app_list show_changelinks=True %}
</div>
{% endblock %}

{% block sidebar %}
<div id="content-related">
  <div class="chart">
    <canvas id="user_chart"></canvas>
  </div>
  <div class="chart" style="overflow: auto;">
    <div style="height: 300px; width: 4200px !important;">
      <canvas id="prefecture_chart"></canvas>
    </div>
  </div>
  <div class="chart anwser_chart">
    <div>
      <canvas id="anwser_chart"></canvas>
    </div>
    <div>
      <canvas id="anwser_type_chart"></canvas>
    </div>
  </div>
  <style>
    .dashboard #content {
      width: auto;
      margin-right: 0;
    }

    .dashboard #content-main {
      width: 600px;
    }

    .dashboard #content-related {
      margin-right: auto;
      margin-left: 20px;
      width: calc(100% - 620px);
      background: inherit;
    }

    .dashboard #content-related .chart {
      background: var(--darkened-bg);
      height: 300px;
      margin-bottom: 20px;
    }

    .dashboard #content-related .chart.anwser_chart {
      display: flex;
    }

    .dashboard #content-related .chart.anwser_chart div:first-child {
      flex-grow: 1;
    }
  </style>

  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    const today = new Date();
    const labels = getDates(new Date(today.setDate(today.getDate() - 29)), new Date())

    function weekDates() {
      const text = ['Mon','Tue','Wed','Thu','Fri','Sat', 'Sun'];

      var current = new Date();
      var week = new Array(); 

      const day = current.getDay();
      current.setDate(current.getDate() - day + (day == 0 ? -6 : 1));
      for (var i = 0; i < 7; i++) {
        const day = text[i] + ' '  + new Date(current).getDate() +  '/' + (new Date(current).getMonth() + 1);
        week.push(day); 
        current.setDate(current.getDate() +1);
      }
      return week; 
    }

    function getDaysInMonth() {
      var current = new Date();
      var date = new Date(current.getFullYear(), current.getMonth(), 1);

      var days = [];
      while (date.getMonth() === current.getMonth()) {
        const day = date.getDate() +  '/' + (date.getMonth() + 1);
        days.push(day);
        date.setDate(date.getDate() + 1);
      }

      return days;
    }

    function getDates(startDate, stopDate) {
      Date.prototype.addDays = function(days) {
          var date = new Date(this.valueOf());
          date.setDate(date.getDate() + days);
          return date;
      }

      var dateArray = new Array();
      var currentDate = new Date(startDate);
      stopDate = new Date(stopDate);
      while (currentDate <= stopDate) {
        dateArray.push(currentDate.getDate() +  '/' + (currentDate.getMonth() + 1));
        currentDate = currentDate.addDays(1);
      }

      return dateArray;
    }
    // ----------------------
    function initChart(data) {
      const {
        user_graph,
        anwser_graph,
        anwser_type_graph,
        prefecture_graph,
        prefectures,
      } = data;

      const user_chart = new Chart(document.getElementById('user_chart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Số người dùng',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: user_graph,
          }]
        },
        options: {
          maintainAspectRatio: false,
        },
      });

      const anwser_chart = new Chart(document.getElementById('anwser_chart'), {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Lượt trả lời câu hỏi',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: anwser_graph,
          }]
        },
        options: {
          maintainAspectRatio: false,
        },
      });

      anwser_count = anwser_type_graph[0] + anwser_type_graph[1];
      right = Math.round((anwser_type_graph[0] / anwser_count) * 100)
      wrong = Math.round((anwser_type_graph[1] / anwser_count) * 100)
      const anwser_type_chart = new Chart(document.getElementById('anwser_type_chart'), {
        type: 'pie',
        data: {
          labels: [`Đúng ${right}%`, `Sai ${wrong}%`],
          datasets: [{
            data: anwser_type_graph,
          }]
        },
        options: {
          tooltips: {
            enabled: false
          },
          plugins: {
            datalabels: {
              formatter: (value, ctx) => {
                let sum = 0;
                let dataArr = ctx.chart.data.datasets[0].data;
                dataArr.map(data => {
                  sum += data;
                });
                let percentage = (value * 100 / sum).toFixed(2) + "%";
                return percentage;
              },
            }
          }
        },
      });
    
      const prefecture_chart = new Chart(document.getElementById('prefecture_chart'), {
        type: 'bar',
        data: {
          labels: prefectures,
          datasets: [{
            label: 'Tổng số người dùng theo từng tỉnh',
            backgroundColor: 'rgb(255, 99, 132)',
            borderColor: 'rgb(255, 99, 132)',
            data: prefecture_graph,
          }]
        },
        options: {
          maintainAspectRatio: false,
          scales: {
            y: {
              beginAtZero: true
            }
          },
        },
      });
    }

    $.ajax({
      type: 'GET',
      url: '/chartdata',
      contentType: "application/json",
      success: function (data) {
        initChart(data.result);
      },  
      error: function (error) {
        console.log(error);
      }
    });
  </script>
</div>
{% endblock %}

